sudo pg_ctlcluster 17 main start

переход в постгрес
sudo -u postgres psql
sudo -u postgres psql -p 5435

create database otus;
\c otus

create table student as 
select 
  generate_series(1,10) as id,
  md5(random()::text)::char(10) as fio;


\copy student to '/mnt/d/2/st.sql';

\help copy

\copy student from '/mnt/d/2/st.sql';


\copy student  to '/mnt/d/2/st.csv' with delimiter ',' ;

\copy student  from '/mnt/d/2/st.csv' with delimiter ',' ; 

----pg_dump
В Линуксе перейти в пользователя postgres
su postgres
или
sudo -u postgres

sudo -u postgres pg_dump -d otus -C -U postgres -p 5435 > /mnt/d/2/arh2.sql 

sudo -u postgres psql -U postgres -p 5435 otus < /mnt/d/2/arh2.sql 


---
архив
sudo -u postgres pg_dump -d otus --create -U postgres -Fc -p 5435 > /mnt/d/2/arh2.gz 


sudo -u postgres pg_restore -d otus -U postgres -p 5435 /mnt/d/2/arh2.gz

----- pg_dumpall 
sudo -u postgres pg_dumpall -U postgres  -p 5435 > /mnt/d/2/bkup_all.sql
psql -U postgres -p 5435 < /mnt/d/2/bkup_all.sql


--------- физический бекап
show wal_level; -- если logical, то переключиться на replica
ALTER SYSTEM SET wal_level = replica;

Рестартуем кластер
sudo pg_ctlcluster 17 main restart

--- создаем новый кластер
sudo pg_createcluster -d /var/lib/postgresql/17/main2 17 main2

--- удаляем в нем каталог
sudo rm -rf /var/lib/postgresql/17/main2

--- создаем копию
sudo -u postgres pg_basebackup -p 5435 -D /var/lib/postgresql/17/main2

--- запускаем новый кластер
sudo pg_ctlcluster 17 main2 start

pg_lsclusters

Удаление кластера
sudo pg_dropcluster 17 main2


----
SELECT name, setting FROM pg_settings WHERE name IN ('archive_mode','archive_command','archive_timeout');

Для создания папки выполните команду
sudo mkdir /archive_wal

Для предоставления прав выполните команду
sudo chown -R postgres:postgres /archive_wal

включить режим архивирования WAL и прописать команду архивирования в файл конфигурации Postgres. 

ALTER SYSTEM SET archive_mode = 'on';
ALTER SYSTEM SET archive_command = 'test ! -f /archive_wal/%f && cp %p /archive_wal/%f';

Чтобы изменения параметров вступили в силу, нужно перезапустить сервер:
sudo systemctl restart postgresql

Создать каталог для полного копирования
sudo mkdir /full_backup
sudo chown -R postgres:postgres /full_backup

Для проведения полного резервного копирования выполните команду
sudo -u postgres pg_basebackup -p 5434 -v -D /full_backup

В клиенте Postgres, например, DBeaver, выполните команды:
create table test (c1 text);

insert into test values ('Проверка восстановления с использованием WAL');

select now(); -- запишите текущее время

update student set fio = 'Иванова';

Для проверки можно выполнить команду 
select * from student;

У всех сотрудников должны быть одинаковые фамилии.

---- восстановления на определенный момент времени:
1.	Остановите сервер Postgres:
sudo systemctl stop postgresql

2.	Ссохраните текущее состояние данных Postgres (на всякий случай).
sudo mkdir /old_data

И после этого переносим в него весь каталог с данными Postgres:
sudo mv /var/lib/postgresql/17/main /old_data

После этого нужно воссоздать каталог main:
sudo mkdir /var/lib/postgresql/17/main

3.	Копируем в main полную резервную копию:
sudo cp -a /full_backup/. /var/lib/postgresql/17/main

4.	В восстановленной резервной копии нужно почистить каталог pg_wal:
sudo rm -rf /var/lib/postgresql/17/main/pg_wal/*
и скопировать в этот каталог последний вариант WAL
sudo cp -a /old_data/main/pg_wal/. /var/lib/postgresql/17/main/pg_wal

5.	Затем редактируем файл конфигурации:
изменить в  postgresql.conf
restore_command = 'cp /archive_wal/%f "%p"'
(команда должна быть строго обратной команде на архивирование WAL )
recovery_target_time = '2025-06-17 09:07:00.962+0300'
(то время, которое мы зафиксировали).

Затем создаем пустой файл recovery.signal:
sudo touch /var/lib/postgresql/17/main/recovery.signal

меняем владение и права на каталог main с подкаталогами:
sudo chown -R postgres:postgres /var/lib/postgresql/17/main/
sudo chmod -R 750 /var/lib/postgresql/17/main/

И запускаем сервер:
sudo systemctl start postgresql

6.	Проверяем в клиенте, что таблица test в базе данных восстановлена:
select * from test;

И ошибочный update в таблице student отменен:
select * from student;

7.	После всех проверок можно открыть доступ к серверу не только на чтение, но и на запись:
select pg_wal_replay_resume();
